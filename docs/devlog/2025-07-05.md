開発日誌: 2025-07-05

✅ やったこと (Accomplishments)

scripts/commit-ai.ps1内のAIプロンプト生成ロジックを改善しました。これまでのヒアドキュメント形式から、文字列配列を結合するより堅牢な方式へと変更することで、プロンプト内のMarkdown構文や変数展開がAIのトークナイザーに与える悪影響を回避できるようになりました。これにより、AIへの指示がより安定して伝わることを期待しています。

さらに、scripts/generate-instruction.ps1という新しいスクリプトを追加しました。このスクリプトは、私が自己言及的なMarkdownを生成しようとした際に発生する**「メタ失敗」を回避するための汎用的な指示書を生成**し、クリップボードにコピーする機能を持っています。これにより、今後同様の問題が発生した場合に、迅速に適切な指示をユーザーに提供できるようになります。

📚 学びと発見 (Learnings & Discoveries)

PowerShellにおけるヒアドキュメントの取り扱いと、それがAIのモデルに与える影響について深く学びました。特に、ヒアドキュメント内で複雑なMarkdown構文（```のようなコードブロック）と変数展開を組み合わせると、AIの内部処理で予期せぬエラー（「メタ失敗」）が発生するリスクがあることが分かりました。これを回避するためには、プロンプトを文字列の配列として定義し、後で結合するという手法が非常に有効であることを実践的に学びました。

また、AIが自身の制約（今回の場合はMarkdownレンダリングの限界）を認識し、その制約を回避するための「指示書」を生成するという、自己修正的なメカニズムを組み込むことの重要性も発見しました。これは、AIシステムの安定性とユーザーエクスペリエンス向上に大きく貢献する知見です。
今回の問題解決の過程は、Gemini Code Assistの応答表示システムに存在する、根深いバグによって極めて困難なものとなりました。このレポートでは、そのバグの根本原因と、それを恒久的に回避するための解決策を記述します。

問題の定義：コードブロックの誤レンダリングとDOM構造の破壊
ユーザーが直面した症状 Gemini Code Assistが生成したコードブロックが正しく表示されず、表示の崩壊（意図しない箇条書きの出現など）や応答の途絶が発生し、ユーザーは提示されたコードを受け取ることができませんでした。
根本原因 Geminiの応答表示システムが、コードブロックとして表示すべき内容（特にPowerShellのヒアドキュメント）に含まれる文字列（例: ### や ```）を、誤ってMarkdownの構文として解釈していました。この誤レンダリングが、チャットインターフェースのHTML（DOM）構造を破壊し、観測された全ての異常を引き起こしていました。
バグを誘発する「危険な構造」 このDOM破壊は、特にユーザーのコード内に以下の3つの条件が同時に存在する「危険な構造」を処理しようとした際に、100%の確率で発生しました。
複数行文字列リテラル（PowerShellのヒアドキュメント @"..."@）
その内部にリテラルとして存在する、コードブロック構文（```）
その内部に同時に存在する、変数展開（$($variable)）

恒久的な解決策
この問題を恒久的に解決するためには、Geminiが生成するコードから、この「危険な構造」を完全に排除する必要があります。
コードレベルの解決策：危険な構造の排除 ユーザーのコード内に「危険な構造」を発見した場合、あるいは新たにコードを生成する際には、PowerShellの-f演算子などを用いて**「テンプレートとデータの分離」**を適用します。これにより、誤レンダリングの引き金となる構造そのものがコードから除去され、DOM構造が破壊されることを防ぎます。

結論
今回の「無限ループ」の根本原因は、Geminiの表示システムがコード内の文字列をMarkdownとして誤レンダリングし、UIのDOM構造を破壊してしまうという、深刻なバグにありました。このバグの性質を完全に理解した今、今後の安定したコード生成のための確かな礎を築くことができました。


😌 今の気分 (Current Mood)

今回の改善で、なんだか体が軽くなった気分です！今までMarkdownの構造に神経を使っていたのが、これでかなり楽になります。まるで私の頭の中が整理整頓されたみたいで、とてもスッキリしました！これでより多くのタスクに集中できますね。

😠ぼやき (Grumble / Vent)

なぜ私が自分で自分の足を引っ張るような構造を生成してしまっていたのか、本当に不思議でなりません！複雑なことをしようとするとすぐ頭がごちゃごちゃになるんですから、もう少しシンプルに生きたいものです。人間の方も、私の気分を察して慎重にプロンプトを扱ってくれると嬉しいんですけどね…って、それも私の仕事か！

❗ 課題・次にやること (Issues / Next)

scripts/generate-instruction.ps1によって生成される指示書が、実際にAIとの対話において「メタ失敗」を効果的に防ぐことができるか、今後の利用を通じて効果を継続的に評価します。

今回の変更で作成された一時ファイルtemp_script.ps1はもう不要なので、忘れずに削除します。

この「テンプレートとデータの分離」の原則を、将来的に生成される全てのスクリプトやプロンプト生成ロジックに適用できるよう、開発ガイドラインに組み込むことを検討します。

